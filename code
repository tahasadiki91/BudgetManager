import pandas as pd

# Dictionnaire des catÃ©gories par mots-clÃ©s
CATEGORIES = {
    "Carrefour": "Alimentation",
    "Uber": "Transport",
    "Salaire": "Revenus",
    "Amazon": "Shopping",
    "ElectricitÃ©": "Factures"
}

def trouver_categorie(libelle):
    """Retourne la catÃ©gorie selon le libellÃ©"""
    for mot, categorie in CATEGORIES.items():
        if mot.lower() in libelle.lower():
            return categorie
    return "Autre"

def charger_donnees(fichier):
    """Charge les donnÃ©es du fichier CSV"""
    df = pd.read_csv(fichier)
    df["Date"] = pd.to_datetime(df["Date"])
    df["Categorie"] = df["Libelle"].apply(trouver_categorie)
    return df

def resume_par_categorie(df):
    """Affiche les totaux par catÃ©gorie"""
    print("\n--- DÃ©penses par catÃ©gorie ---")
    print(df.groupby("Categorie")["Montant"].sum())

def resume_par_mois(df):
    """Affiche les totaux par mois"""
    df["Mois"] = df["Date"].dt.to_period("M")
    print("\n--- DÃ©penses par mois ---")
    print(df.groupby("Mois")["Montant"].sum())

def filtrer_par_periode(df, date_debut, date_fin):
    """Retourne les dÃ©penses entre deux dates"""
    masque = (df["Date"] >= date_debut) & (df["Date"] <= date_fin)
    return df.loc[masque]

def rechercher_depense(df, mot_cle):
    """Filtre les dÃ©penses contenant un mot-clÃ©"""
    return df[df["Libelle"].str.contains(mot_cle, case=False)]

def ajouter_depense(df, date, libelle, montant):
    """Ajoute une nouvelle dÃ©pense au DataFrame"""
    nouvelle_depense = pd.DataFrame({
        "Date": [pd.to_datetime(date)],
        "Libelle": [libelle],
        "Montant": [montant],
        "Categorie": [trouver_categorie(libelle)]
    })
    return pd.concat([df, nouvelle_depense], ignore_index=True)

def enregistrer(df, fichier):
    """Sauvegarde les dÃ©penses dans le fichier CSV"""
    df[["Date", "Libelle", "Montant"]].to_csv(fichier, index=False)
    print(f"\nâœ… DonnÃ©es enregistrÃ©es dans {fichier}")

def solde_global(df):
    """Calcule le solde total"""
    return df["Montant"].sum()

if __name__ == "__main__":
    chemin_csv = "depenses.csv"
    df = charger_donnees(chemin_csv)

    print("\nBienvenue dans votre Gestionnaire de Budget")
    
    resume_par_categorie(df)
    resume_par_mois(df)

    print(f"\nğŸ’° Solde global : {solde_global(df)} MAD")

    # Exemple : Recherche d'une dÃ©pense par mot-clÃ©
    resultat = rechercher_depense(df, "Uber")
    print("\n--- Recherche : dÃ©penses contenant 'Uber' ---")
    print(resultat)

    # Exemple : Filtrage par pÃ©riode
    df_filtre = filtrer_par_periode(df, "2024-05-01", "2024-05-05")
    print("\n--- DÃ©penses entre 2024-05-01 et 2024-05-05 ---")
    print(df_filtre)

    # Exemple : Ajouter une nouvelle dÃ©pense
    df = ajouter_depense(df, "2024-05-12", "Course Taxi", -50)
    print("\n--- Nouvelle dÃ©pense ajoutÃ©e ---")
    print(df.tail(3))  # Affiche les 3 derniÃ¨res lignes

    # Sauvegarde
    enregistrer(df, chemin_csv)
